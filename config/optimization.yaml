# Optimization configuration for ML strategy improvement
# Central configuration for walk-forward validation, hyperparameter tuning, and analysis

optimization:
  # =============================================================================
  # Walk-Forward Validation Settings
  # =============================================================================
  # Proper out-of-sample testing with rolling train/test windows
  walk_forward:
    enabled: true
    train_window: 2160       # 90 days of 1h candles (2160 = 90 * 24)
    test_window: 336         # 14 days of 1h candles (336 = 14 * 24)
    step_size: 168           # Roll forward 7 days at a time
    min_train_samples: 1500  # Minimum samples required for training
    
    strategies:
      # New robust strategies
      - ml_classifier_v5
      - ml_classifier_online
      - rule_ensemble
      - ml_cross_asset
      # Legacy strategies for comparison
      - ml_classifier_xgb
      - ml_classifier_hybrid
      - ml_ensemble_voting
    
    symbols:
      # All available symbols from extended dataset
      - BTCUSDT
      - ETHUSDT
      - BNBUSDT
      - XRPUSDT
      - SOLUSDT
      - ADAUSDT
      - DOGEUSDT
      - AVAXUSDT
      - DOTUSDT
      - LINKUSDT
      - LTCUSDT
      - NEARUSDT
      - APTUSDT
      - ATOMUSDT
      - UNIUSDT
      - AAVEUSDT
      - XLMUSDT
      - MATICUSDT
      - SHIBUSDT
      - TRXUSDT
    
    interval: 1h
    days: 365                # Full year of data for walk-forward
    
    # Acceptance criteria for strategy validation
    acceptance:
      min_oos_sharpe: 0.5
      max_degradation_pct: 40
      min_trades_per_fold: 5
  
  # =============================================================================
  # Validation Gates
  # =============================================================================
  # Criteria that must be met for a strategy to be considered production-ready
  validation_gates:
    enabled: true
    criteria:
      - name: positive_oos_sharpe
        metric: oos_sharpe
        operator: gt
        threshold: 0
      - name: acceptable_degradation
        metric: sharpe_degradation
        operator: lt
        threshold: 50
      - name: sufficient_trades
        metric: oos_total_trades
        operator: gt
        threshold: 20
      - name: acceptable_drawdown
        metric: oos_max_dd
        operator: lt
        threshold: 25
    
    # Fail-safe: reject if ALL folds show negative OOS
    reject_all_negative_folds: true

  # =============================================================================
  # Hyperparameter Grid Search
  # =============================================================================
  # Parameter grids for each strategy to optimize
  hyperparameters:
    ml_classifier_xgb:
      # Model parameters
      n_estimators: [100, 150, 200, 300]
      max_depth: [4, 5, 6, 8]
      learning_rate: [0.01, 0.05, 0.1]
      # Trading parameters
      buy_threshold: [0.52, 0.55, 0.58]
      sell_threshold: [0.42, 0.45, 0.48]
      use_class_weights: [true]
    
    ml_classifier_hybrid:
      # Ensemble weights
      xgb_weight: [0.5, 0.6, 0.7]
      rf_weight: [0.3, 0.4, 0.5]
      # Model parameters
      n_estimators: [100, 150, 200]
      max_depth: [5, 6, 7]
      # Adaptive thresholds
      trend_buy_threshold: [0.50, 0.52, 0.55]
      trend_sell_threshold: [0.45, 0.48, 0.50]
      range_buy_threshold: [0.55, 0.58, 0.60]
      range_sell_threshold: [0.40, 0.42, 0.45]
    
    ml_ensemble_voting:
      rf_n_estimators: [50, 100, 150]
      gb_n_estimators: [50, 100, 150]
      buy_threshold: [0.52, 0.55, 0.58]
      sell_threshold: [0.42, 0.45, 0.48]
    
    # =========================================================================
    # Validated Strategies (Note 08-09 Winners)
    # Reduced grid sizes for practical runtime (~100-200 combos each)
    # =========================================================================
    eth_btc_ratio_reversion:
      # Strategy params (key ones only)
      lookback: [96, 120, 168]
      entry_threshold: [-2.0, -1.5]
      exit_threshold: [-0.5, -0.7]
      max_hold_hours: [48, 72]
      # Risk params
      stop_loss_pct: [0.04, 0.06]
      take_profit_pct: [0.10, 0.15]
    
    eth_btc_ratio_confirmed:
      # Strategy params
      lookback: [96, 120, 168]
      entry_threshold: [-2.0, -1.5]
      exit_threshold: [-0.5, -0.7]
      max_hold_hours: [48, 72]
      confirmation_delay: [2, 3]
      # Risk params
      stop_loss_pct: [0.04, 0.06]
      take_profit_pct: [0.10, 0.15]
    
    volume_divergence:
      # Strategy params
      price_lookback: [24, 48]
      volume_lookback: [24, 48]
      price_threshold: [0.03, 0.05]
      volume_decline_threshold: [0.25, 0.35]
      # Risk params
      stop_loss_pct: [0.02, 0.03]
      take_profit_pct: [0.05, 0.07]
    
    signal_confirmation_delay:
      # Strategy params
      confirmation_delay: [2, 3, 4]
      require_consistent: [true]
      # Risk params
      stop_loss_pct: [0.03, 0.04]
      take_profit_pct: [0.08, 0.10]
    
    basis_proxy:
      # Strategy params
      funding_lookback: [6, 9, 12]
      entry_threshold: [-0.0004, -0.0003]
      exit_threshold: [0.0002, 0.0003]
      max_hold_hours: [48, 72]
      # Risk params
      stop_loss_pct: [0.03, 0.04]
      take_profit_pct: [0.08, 0.10]

  # =============================================================================
  # Risk Parameter Grid Search
  # =============================================================================
  # Stop-loss and take-profit optimization
  risk_params:
    stop_loss_pct: [0.02, 0.03, 0.04, 0.05, 0.06]
    take_profit_pct: [0.06, 0.08, 0.10, 0.12, 0.15]
    trailing_stop_pct: [null, 0.03, 0.05]  # null = disabled
    
    strategies:
      - ml_classifier_xgb
      - ml_classifier_hybrid
      - ml_ensemble_voting
    
    symbols:
      - APTUSDT
      - NEARUSDT
      - DOTUSDT
      - XLMUSDT
      - XRPUSDT
    
    interval: 1h
    days: 90

  # =============================================================================
  # Out-of-Sample Testing
  # =============================================================================
  # Test on holdout data not used during development
  out_of_sample:
    # Time-based holdout (recent period)
    test_period:
      start: "2024-10-01"
      end: "2024-12-21"
    
    # Symbol-based holdout (coins not used in development)
    holdout_symbols:
      - AVAXUSDT
      - LINKUSDT
      - UNIUSDT
      - AAVEUSDT
      - ATOMUSDT
    
    # Development symbols (for comparison)
    dev_symbols:
      - APTUSDT
      - NEARUSDT
      - DOTUSDT
    
    strategies:
      - ml_classifier_xgb
      - ml_classifier_hybrid
      - ml_ensemble_voting
    
    interval: 1h

  # =============================================================================
  # Feature Importance Analysis
  # =============================================================================
  feature_analysis:
    strategies:
      - ml_classifier_xgb
    
    top_n_features: 10
    use_shap: true           # Use SHAP values for interpretability
    
    # Features to analyze
    features:
      - sma_20
      - ema_12
      - rsi_14
      - macd
      - adx
      - atr_ratio
      - bb_width
      - obv
      - volume_momentum
      - roc_10
    
    symbols:
      - APTUSDT
      - NEARUSDT
    
    interval: 1h
    days: 90

  # =============================================================================
  # Output Settings
  # =============================================================================
  output:
    results_dir: notes/optimization_results
    save_json: true
    save_plots: true
    verbose: true

  # =============================================================================
  # Creative Strategy Testing
  # =============================================================================
  # Comprehensive testing of alternative alpha sources on hourly data
  # Based on research findings: need new alpha sources, not just better ML
  creative_testing:
    enabled: true
    
    # Phase 1: Quick Validation - rapid filtering
    quick_validation:
      symbols: [BTCUSDT, ETHUSDT, SOLUSDT]
      train_window: 1440           # 60 days
      test_window: 336             # 14 days
      step_size: 336               # Bi-weekly
      days: 180                    # 6 months
      
      strategies:
        # Category A: Cross-Symbol
        - btc_lead_alt_follow
        - eth_btc_ratio_reversion
        - correlation_breakdown
        - sector_momentum_rotation
        - btc_volatility_filter
        # Category B: Alternative Data
        - funding_rate_fade
        - funding_rate_carry
        - open_interest_divergence
        # Category C: Calendar
        - weekend_effect
        - hour_of_day_filter
        - month_end_rebalancing
        # Category D: Frequency Reduction
        - weekly_momentum
        - signal_confirmation_delay
        - signal_strength_filter
        # Category E: Meta
        - regime_gate
        - drawdown_pause
        - strategy_momentum
        # Category F: Microstructure
        - volume_breakout_confirmation
        - volume_divergence
        - buy_sell_imbalance
      
      # Lenient threshold for quick filter
      pass_threshold:
        min_oos_sharpe: -2.0
        top_n_to_advance: 8
    
    # Phase 2: Deep Validation - full walk-forward
    deep_validation:
      symbols:
        - BTCUSDT
        - ETHUSDT
        - BNBUSDT
        - XRPUSDT
        - SOLUSDT
        - ADAUSDT
        - DOGEUSDT
        - AVAXUSDT
        - DOTUSDT
        - LINKUSDT
        - LTCUSDT
        - NEARUSDT
        - APTUSDT
        - ATOMUSDT
        - UNIUSDT
        - AAVEUSDT
        - XLMUSDT
        - MATICUSDT
        - SHIBUSDT
      
      train_window: 2160           # 90 days
      test_window: 336             # 14 days
      step_size: 168               # Weekly
      days: 365                    # Full year
      
      # Strict acceptance criteria
      acceptance:
        min_oos_sharpe: 0.5
        max_degradation_pct: 50
        min_trades_per_month: 2
        max_trades_per_month: 20
        max_drawdown_pct: 20
        min_symbol_pass_rate: 0.6
      
      # Must beat buy-and-hold
      compare_to_baseline: true
      baseline: buy_and_hold
    
    # Phase 3: Robustness Testing
    robustness:
      # Cost sensitivity
      commission_rates: [0.0005, 0.001, 0.0015]
      slippage_rates: [0.0003, 0.0005, 0.001]
      
      # Time periods
      time_periods:
        - name: "2023_H2"
          start: "2023-07-01"
          end: "2023-12-31"
        - name: "2024_H1"
          start: "2024-01-01"
          end: "2024-06-30"
        - name: "2024_H2"
          start: "2024-07-01"
          end: "2024-12-21"
      
      # Holdout symbols
      holdout_symbols:
        - AVAXUSDT
        - LINKUSDT
        - UNIUSDT
        - AAVEUSDT
        - ATOMUSDT
      
      # Parameter sensitivity
      parameter_variation_pct: 20
    
    # Reference symbols for cross-symbol strategies
    reference_symbols:
      - BTCUSDT
      - ETHUSDT
    
    # Output
    results_dir: notes/creative_testing_results
